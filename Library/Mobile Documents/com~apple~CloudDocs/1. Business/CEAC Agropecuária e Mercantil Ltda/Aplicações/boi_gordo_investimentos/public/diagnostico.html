<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico - Boi Gordo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        #console-output { background: #f8f9fa; padding: 15px; max-height: 300px; overflow-y: auto; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico - Boi Gordo Investimentos</h1>
    
    <div class="test-section">
        <h2>1. Carregamento de Depend√™ncias</h2>
        <div id="dependencias-result"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Scripts da Aplica√ß√£o</h2>
        <div id="scripts-result"></div>
        <button onclick="testarScripts()">Testar Scripts</button>
    </div>
    
    <div class="test-section">
        <h2>3. Estado da Aplica√ß√£o</h2>
        <div id="estado-result"></div>
        <button onclick="testarEstado()">Verificar Estado</button>
    </div>
    
    <div class="test-section">
        <h2>4. Elementos DOM</h2>
        <div id="dom-result"></div>
        <button onclick="testarDOM()">Testar DOM</button>
    </div>
    
    <div class="test-section">
        <h2>5. Navega√ß√£o</h2>
        <div id="navegacao-result"></div>
        <button onclick="testarNavegacao()">Testar Navega√ß√£o</button>
    </div>
    
    <div class="test-section">
        <h2>6. Abrir Aplica√ß√£o Principal</h2>
        <button onclick="abrirAplicacao()">Abrir Aplica√ß√£o</button>
        <button onclick="recarregarAplicacao()">Recarregar e Abrir</button>
    </div>
    
    <div class="test-section">
        <h2>Console Output</h2>
        <div id="console-output"></div>
        <button onclick="limparConsole()">Limpar Console</button>
    </div>

    <!-- Carregar depend√™ncias primeiro -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="data_api.js"></script>

    <script>
        let consoleLog = [];
        
        // Interceptar console.log
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            consoleLog.push({type: 'log', message: args.join(' ')});
            updateConsole();
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            consoleLog.push({type: 'error', message: args.join(' ')});
            updateConsole();
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            consoleLog.push({type: 'warn', message: args.join(' ')});
            updateConsole();
            originalWarn.apply(console, args);
        };
        
        function updateConsole() {
            const output = document.getElementById('console-output');
            if (output) {
                output.innerHTML = consoleLog.map(log => 
                    `<div class="${log.type}">[${log.type.toUpperCase()}] ${log.message}</div>`
                ).join('');
                output.scrollTop = output.scrollHeight;
            }
        }
        
        function limparConsole() {
            consoleLog = [];
            updateConsole();
        }
        
        function addResult(containerId, message, type = 'success') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = message;
            container.appendChild(div);
        }
        
        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }
        
        // Teste 1: Depend√™ncias
        function testarDependencias() {
            clearResults('dependencias-result');
            
            // Chart.js
            if (typeof Chart !== 'undefined') {
                addResult('dependencias-result', '‚úÖ Chart.js carregado', 'success');
            } else {
                addResult('dependencias-result', '‚ùå Chart.js n√£o encontrado', 'error');
            }
            
            // XLSX
            if (typeof XLSX !== 'undefined') {
                addResult('dependencias-result', '‚úÖ XLSX carregado', 'success');
            } else {
                addResult('dependencias-result', '‚ùå XLSX n√£o encontrado', 'error');
            }
            
            // DataAPI
            if (typeof window.DataAPI !== 'undefined') {
                addResult('dependencias-result', '‚úÖ DataAPI carregado', 'success');
            } else {
                addResult('dependencias-result', '‚ùå DataAPI n√£o encontrado', 'error');
            }
            
            // localStorage
            try {
                localStorage.setItem('teste', 'ok');
                localStorage.removeItem('teste');
                addResult('dependencias-result', '‚úÖ localStorage funcionando', 'success');
            } catch(e) {
                addResult('dependencias-result', '‚ùå localStorage com erro: ' + e.message, 'error');
            }
        }
        
        // Teste 2: Scripts
        function testarScripts() {
            clearResults('scripts-result');
            
            // Tentar carregar app.js
            const script1 = document.createElement('script');
            script1.src = 'js/app.js';
            script1.onload = function() {
                addResult('scripts-result', '‚úÖ app.js carregado', 'success');
                
                setTimeout(() => {
                    if (typeof window.AppState !== 'undefined') {
                        addResult('scripts-result', '‚úÖ AppState dispon√≠vel', 'success');
                        addResult('scripts-result', `üìä Dados: ${Object.keys(window.AppState.data).length} chaves`, 'success');
                    } else {
                        addResult('scripts-result', '‚ùå AppState n√£o dispon√≠vel', 'error');
                    }
                }, 100);
            };
            script1.onerror = function() {
                addResult('scripts-result', '‚ùå Erro ao carregar app.js', 'error');
            };
            document.head.appendChild(script1);
            
            // Tentar carregar charts.js
            setTimeout(() => {
                const script2 = document.createElement('script');
                script2.src = 'js/charts.js';
                script2.onload = function() {
                    addResult('scripts-result', '‚úÖ charts.js carregado', 'success');
                    
                    if (typeof window.ChartsManager !== 'undefined') {
                        addResult('scripts-result', '‚úÖ ChartsManager dispon√≠vel', 'success');
                    } else {
                        addResult('scripts-result', '‚ö†Ô∏è ChartsManager n√£o dispon√≠vel', 'warning');
                    }
                };
                script2.onerror = function() {
                    addResult('scripts-result', '‚ùå Erro ao carregar charts.js', 'error');
                };
                document.head.appendChild(script2);
            }, 500);
        }
        
        // Teste 3: Estado
        function testarEstado() {
            clearResults('estado-result');
            
            if (typeof window.AppState === 'undefined') {
                addResult('estado-result', '‚ùå AppState n√£o encontrado - executar Teste 2 primeiro', 'error');
                return;
            }
            
            const state = window.AppState;
            addResult('estado-result', `‚úÖ Se√ß√£o atual: ${state.currentSection}`, 'success');
            addResult('estado-result', `‚úÖ Tema escuro: ${state.darkTheme}`, 'success');
            addResult('estado-result', `‚úÖ Inicializado: ${state.initialized}`, state.initialized ? 'success' : 'warning');
            
            if (state.data) {
                addResult('estado-result', `üìä Transa√ß√µes: ${state.data.transacoes?.length || 0}`, 'success');
                addResult('estado-result', `üìä Posi√ß√µes abertas: ${state.data.posicoesAbertas?.length || 0}`, 'success');
                addResult('estado-result', `üìä Posi√ß√µes liquidadas: ${state.data.posicoesLiquidadas?.length || 0}`, 'success');
                addResult('estado-result', `üí∞ Pre√ßos configurados: ${Object.keys(state.data.precos || {}).length}`, 'success');
            }
        }
        
        // Teste 4: DOM
        function testarDOM() {
            clearResults('dom-result');
            
            // Abrir iframe para testar DOM da aplica√ß√£o principal
            const iframe = document.createElement('iframe');
            iframe.src = '/';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            iframe.onload = function() {
                const doc = iframe.contentDocument;
                
                // Testar elementos principais
                const sidebar = doc.querySelector('.sidebar');
                const mainContent = doc.querySelector('.main-content');
                const dashboard = doc.getElementById('dashboard');
                const navLinks = doc.querySelectorAll('.nav-link');
                
                if (sidebar) {
                    addResult('dom-result', '‚úÖ Sidebar encontrada', 'success');
                } else {
                    addResult('dom-result', '‚ùå Sidebar n√£o encontrada', 'error');
                }
                
                if (mainContent) {
                    addResult('dom-result', '‚úÖ Main content encontrado', 'success');
                } else {
                    addResult('dom-result', '‚ùå Main content n√£o encontrado', 'error');
                }
                
                if (dashboard) {
                    addResult('dom-result', '‚úÖ Dashboard encontrado', 'success');
                } else {
                    addResult('dom-result', '‚ùå Dashboard n√£o encontrado', 'error');
                }
                
                addResult('dom-result', `‚úÖ Links de navega√ß√£o: ${navLinks.length}`, navLinks.length > 0 ? 'success' : 'error');
                
                // Testar se CSS foi carregado
                const computed = iframe.contentWindow.getComputedStyle(sidebar || doc.body);
                if (computed.fontFamily) {
                    addResult('dom-result', '‚úÖ CSS carregado', 'success');
                } else {
                    addResult('dom-result', '‚ùå CSS n√£o carregado', 'error');
                }
                
                document.body.removeChild(iframe);
            };
        }
        
        // Teste 5: Navega√ß√£o
        function testarNavegacao() {
            clearResults('navegacao-result');
            
            if (typeof window.navegarPara === 'undefined') {
                addResult('navegacao-result', '‚ùå Fun√ß√£o navegarPara n√£o dispon√≠vel', 'error');
                return;
            }
            
            try {
                // Simular navega√ß√£o
                addResult('navegacao-result', 'üß™ Testando navega√ß√£o...', 'warning');
                
                // Abrir nova janela para teste
                const testWindow = window.open('/', 'teste', 'width=800,height=600');
                
                setTimeout(() => {
                    if (testWindow && !testWindow.closed) {
                        addResult('navegacao-result', '‚úÖ Janela de teste aberta', 'success');
                        
                        setTimeout(() => {
                            testWindow.close();
                            addResult('navegacao-result', '‚úÖ Teste de navega√ß√£o conclu√≠do', 'success');
                        }, 3000);
                    } else {
                        addResult('navegacao-result', '‚ö†Ô∏è N√£o foi poss√≠vel abrir janela de teste', 'warning');
                    }
                }, 1000);
                
            } catch (error) {
                addResult('navegacao-result', '‚ùå Erro ao testar navega√ß√£o: ' + error.message, 'error');
            }
        }
        
        function abrirAplicacao() {
            window.open('/', '_blank');
        }
        
        function recarregarAplicacao() {
            // For√ßar recarga completa
            window.open('/?t=' + Date.now(), '_blank');
        }
        
        // Executar testes autom√°ticos ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Iniciando diagn√≥stico autom√°tico...');
            
            setTimeout(() => {
                testarDependencias();
            }, 500);
            
            setTimeout(() => {
                testarScripts();
            }, 1000);
            
            setTimeout(() => {
                testarEstado();
            }, 2000);
            
            setTimeout(() => {
                testarDOM();
            }, 2500);
        });
    </script>
</body>
</html> 